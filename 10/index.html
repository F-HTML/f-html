<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-time Chat with File Upload</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f5f5f5;
      user-select: none;
    }

    #login-container, #chat-container {
      width: 400px;
      background: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    #login-form, #message-form {
      display: flex;
      flex-direction: column;
    }

    #login-form input, #message-form input {
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ddd;
    }

    #login-form button, #message-form button {
      padding: 10px;
      background: #007bff;
      border: none;
      color: white;
      cursor: pointer;
      margin-bottom: 10px;
    }

    #login-form button:hover, #message-form button:hover {
      background: #0056b3;
    }

    #messages {
      height: 300px;
      overflow-y: scroll;
      border: 1px solid #ddd;
      margin-bottom: 20px;
      padding: 10px;
      background: #fafafa;
    }

    #progress-container {
      display: none;
      margin-bottom: 10px;
    }

    #progress-bar {
      width: 0%;
      height: 4px;
      background: #007bff;
    }
    
    #delete-messages {
      display: none;
    }
  </style>
</head>
<body>
  <div id="login-container">
    <h2>Login</h2>
    <form id="login-form">
      <input type="text" id="name" placeholder="Name" required>
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit">Login</button>
      <button id="sign-up">Sign Up</button>
    </form>
  </div>
  <div id="chat-container" style="display: none;">
    <h2>Grup Desa</h2>
    <div id="messages"></div>
    <form id="message-form">
      <input type="file" id="file-input" accept="image/*,video/*,audio/*,text/*" />
      <input type="text" id="message-input" placeholder="Type a message" />
      <button type="submit">Send</button>
    </form>
    <div id="progress-container">
      <div id="progress-bar"></div>
    </div>
    <button id="delete-messages">Delete All Messages</button>
  </div>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-storage.js"></script>
  <script>
    // Konfigurasi Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCxYndc1H5O4mfAlnaHtYSabgUgk8A7WxM",
      authDomain: "chatfirebasemaxs.firebaseapp.com",
      databaseURL: "https://chatfirebasemaxs-default-rtdb.firebaseio.com",
      projectId: "chatfirebasemaxs",
      storageBucket: "chatfirebasemaxs.appspot.com",
      messagingSenderId: "1039211175918",
      appId: "1:1039211175918:web:4315601948bf886b72f8ff"
    };

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();
    const storageRef = storage.ref();

    // Elemen DOM
    const loginContainer = document.getElementById('login-container');
    const chatContainer = document.getElementById('chat-container');
    const loginForm = document.getElementById('login-form');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const signUpButton = document.getElementById('sign-up');
    const messagesDiv = document.getElementById('messages');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const fileInput = document.getElementById('file-input');
    const nameInput = document.getElementById('name');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const deleteMessagesButton = document.getElementById('delete-messages');

    // Daftar kata kasar
    const badWords = ["kontol", "k0nt0l", "memek", "m3m3k", "kntl", "beban", "hencet", "heuncet", "mek", "kon", "ngen", "ngentot", "beban", "bbn", "asu", "janc", "jank", "janco", "jancok", "babi", "aying", "anying", "anjing"];

    function filterBadWords(text) {
      let filteredText = text;
      badWords.forEach(word => {
        const regex = new RegExp(`\\b${word}\\b`, 'gi');
        filteredText = filteredText.replace(regex, '(^_^)');
      });
      return filteredText;
    }

    // Fungsi untuk menampilkan pesan
    function displayMessage(text, name, fileUrl, fileType) {
      const messageElement = document.createElement('div');
      const filteredText = filterBadWords(text);
      const messageContent = document.createElement('div');

      if (fileUrl) {
        if (fileType.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = fileUrl;
          img.style.maxWidth = '100%';
          img.style.maxHeight = '200px';
          messageContent.appendChild(img);
        } else if (fileType.startsWith('video/')) {
          const video = document.createElement('video');
          video.src = fileUrl;
          video.controls = true;
          video.style.maxWidth = '100%';
          messageContent.appendChild(video);
        } else if (fileType.startsWith('audio/')) {
          const audio = document.createElement('audio');
          audio.src = fileUrl;
          audio.controls = true;
          messageContent.appendChild(audio);
        } else {
          const fileLink = document.createElement('a');
          fileLink.href = fileUrl;
          fileLink.textContent = 'Download File';
          fileLink.target = '_blank';
          messageContent.appendChild(fileLink);
        }
      } else {
        messageContent.textContent = filteredText;
      }

      messageElement.textContent = `${name}: `;
      messageElement.appendChild(messageContent);
      messagesDiv.appendChild(messageElement);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Fungsi untuk mengunggah file
    function uploadFile(file) {
      const fileRef = storageRef.child(`files/${file.name}`);
      const uploadTask = fileRef.put(file);

      uploadTask.on('state_changed',
        function(snapshot) {
          // Progres pengunggahan bisa ditangani di sini
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          progressBar.style.width = `${progress}%`;
          progressContainer.style.display = 'block';
        },
        function(error) {
          console.error('Kesalahan Pengunggahan:', error);
        },
        function() {
          uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
            db.ref('messages').push({
              text: messageInput.value.trim(),
              name: localStorage.getItem('userName'),
              fileUrl: downloadURL,
              fileType: file.type
            });
            messageInput.value = '';
            fileInput.value = ''; // Clear the file input
            progressContainer.style.display = 'none';
            progressBar.style.width = '0%';
          });
        }
      );
    }

    // Event listener untuk form pesan
    messageForm.addEventListener('submit', function(event) {
      event.preventDefault();
      const text = messageInput.value.trim();
      const file = fileInput.files[0];
      const name = localStorage.getItem('userName');

      if (text === '' && !file) {
        alert('Silakan Masukkan Pesan atau Pilih File.');
        return;
      }

      if (file) {
        uploadFile(file);
      } else {
        db.ref('messages').push({
          text: text,
          name: name
        });
        messageInput.value = '';
      }
    });

// Fungsi untuk memuat pesan
        function loadMessages() {
          db.ref('messages').on('child_added', function(snapshot) {
            const message = snapshot.val();
            displayMessage(message.text, message.name, message.fileUrl, message.fileType);
          });
        }

        // Event listener untuk form login dan sign up
        loginForm.addEventListener('submit', function(event) {
          event.preventDefault();
          const email = emailInput.value;
          const password = passwordInput.value;
          const name = nameInput.value.trim();
          if (name === '') {
            alert('Silakan Masukkan Nama.');
            return;
          }
          auth.signInWithEmailAndPassword(email, password)
            .then(() => {
              localStorage.setItem('userName', name); // Simpan nama pengguna di localStorage
              loginContainer.style.display = 'none';
              chatContainer.style.display = 'block';
              loadMessages();
            })
            .catch(error => {
              console.error('Kesalahan Masuk:', error);
              alert('Gagal Masuk. Silakan Periksa Email Dan Kata Sandi Anda.');
            });
        });

        signUpButton.addEventListener('click', function(event) {
          event.preventDefault();
          const email = emailInput.value;
          const password = passwordInput.value;
          const name = nameInput.value.trim();
          if (name === '') {
            alert('Silahkan Masukkan Nama Anda.');
            return;
          }
          auth.createUserWithEmailAndPassword(email, password)
            .then(() => {
              localStorage.setItem('userName', name); // Simpan nama pengguna di localStorage
              alert('Pengguna Berhasil Dibuat. Silakan Masuk.');
            })
            .catch(error => {
              console.error('Kesalahan Pendaftaran:', error);
              alert('Pendaftaran Gagal. Silakan Coba Lagi.');
            });
        });

        auth.onAuthStateChanged(user => {
          if (user) {
            loginContainer.style.display = 'none';
            chatContainer.style.display = 'block';
            loadMessages();
          } else {
            loginContainer.style.display = 'block';
            chatContainer.style.display = 'none';
          }
        });

        // Fungsi untuk menghapus semua pesan
        deleteMessagesButton.addEventListener('click', function() {
          db.ref('messages').remove()
            .then(() => {
              messagesDiv.innerHTML = ''; // Clear the messages div
              alert('Semua pesan telah dihapus.');
            })
            .catch(error => {
              console.error('Kesalahan saat menghapus pesan:', error);
              alert('Gagal menghapus pesan.');
            });
        });

        window.onload = () => {
          alert("Jangan Masukkan Email & Password Pribadi. Masukkan Email & Password Random Aja Yang Penting Mudah Diingat Dan Jangan Lupa Namanya Juga Harus Di Ingat Juga. Kasih Nama Yang Sopan.");
        };
    </script>
</body>
</html>